<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>NL2SQL Dashboard</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				min-height: 100vh;
				padding: 20px;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
				background: white;
				border-radius: 16px;
				box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
				overflow: hidden;
			}

			.header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 30px;
			}

			.header h1 {
				font-size: 32px;
				margin-bottom: 8px;
				display: flex;
				align-items: center;
				gap: 12px;
			}

			.header p {
				opacity: 0.9;
				font-size: 14px;
			}

			.stats {
				display: flex;
				gap: 20px;
				margin-top: 20px;
				flex-wrap: wrap;
			}

			.stat-item {
				background: rgba(255, 255, 255, 0.2);
				padding: 12px 20px;
				border-radius: 8px;
				backdrop-filter: blur(10px);
				font-size: 14px;
			}

			.stat-item strong {
				font-size: 18px;
				display: block;
				margin-top: 4px;
			}

			.content {
				padding: 30px;
			}

			.query-section {
				margin-bottom: 24px;
			}

			textarea {
				width: 100%;
				padding: 16px;
				border: 2px solid #e2e8f0;
				border-radius: 8px;
				font-size: 15px;
				font-family: inherit;
				resize: vertical;
				transition: all 0.3s;
				min-height: 80px;
			}

			textarea:focus {
				outline: none;
				border-color: #667eea;
				box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
			}

			textarea::placeholder {
				color: #94a3b8;
			}

			.button-group {
				display: flex;
				gap: 12px;
				flex-wrap: wrap;
				margin-top: 16px;
			}

			button {
				padding: 12px 24px;
				border: none;
				border-radius: 8px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
				display: flex;
				align-items: center;
				gap: 8px;
			}

			button:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			}

			button:active {
				transform: translateY(0);
			}

			button:disabled {
				opacity: 0.5;
				cursor: not-allowed;
				transform: none !important;
			}

			.btn-primary {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
			}

			.btn-secondary {
				background: #64748b;
				color: white;
			}

			.btn-danger {
				background: #ef4444;
				color: white;
			}

			.alert {
				padding: 16px 20px;
				border-radius: 8px;
				margin: 20px 0;
				display: flex;
				align-items: flex-start;
				gap: 12px;
			}

			.alert-success {
				background: #d1fae5;
				color: #065f46;
				border-left: 4px solid #10b981;
			}

			.alert-error {
				background: #fee2e2;
				color: #991b1b;
				border-left: 4px solid #ef4444;
			}

			.alert-icon {
				font-size: 20px;
				flex-shrink: 0;
			}

			.alert-content {
				flex: 1;
			}

			.alert-content small {
				display: block;
				margin-top: 4px;
				opacity: 0.8;
				font-size: 13px;
			}

			.cache-badge {
				display: inline-block;
				background: #10b981;
				color: white;
				padding: 4px 12px;
				border-radius: 12px;
				font-size: 12px;
				font-weight: 600;
				margin-left: 8px;
			}

			.sql-block {
				background: #1e293b;
				color: #e2e8f0;
				padding: 20px;
				border-radius: 8px;
				overflow-x: auto;
				margin: 16px 0;
				font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
				font-size: 14px;
				line-height: 1.6;
			}

			.sql-block code {
				color: #38bdf8;
			}

			.results-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin: 24px 0 16px 0;
			}

			.results-header h3 {
				color: #1e293b;
				font-size: 20px;
			}

			.row-count {
				background: #f1f5f9;
				padding: 6px 14px;
				border-radius: 6px;
				font-size: 14px;
				font-weight: 600;
				color: #475569;
			}

			.table-wrapper {
				overflow-x: auto;
				border: 1px solid #e2e8f0;
				border-radius: 8px;
				margin-top: 16px;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				min-width: 800px;
			}

			thead {
				background: #f8fafc;
				position: sticky;
				top: 0;
				z-index: 10;
			}

			th {
				padding: 14px 16px;
				text-align: left;
				font-weight: 600;
				font-size: 13px;
				color: #475569;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				border-bottom: 2px solid #e2e8f0;
				white-space: nowrap;
			}

			td {
				padding: 12px 16px;
				border-bottom: 1px solid #f1f5f9;
				font-size: 14px;
				color: #334155;
				max-width: 250px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			tr:hover {
				background: #f8fafc;
			}

			tr:last-child td {
				border-bottom: none;
			}

			.null-value {
				color: #94a3b8;
				font-style: italic;
				font-size: 13px;
			}

			.truncated {
				cursor: help;
				position: relative;
			}

			.truncated:hover::after {
				content: attr(data-full);
				position: absolute;
				background: #1e293b;
				color: white;
				padding: 8px 12px;
				border-radius: 6px;
				font-size: 12px;
				white-space: normal;
				max-width: 300px;
				z-index: 1000;
				left: 0;
				top: 100%;
				margin-top: 4px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			}

			.loading {
				text-align: center;
				padding: 60px 20px;
			}

			.spinner {
				border: 4px solid #f1f5f9;
				border-top: 4px solid #667eea;
				border-radius: 50%;
				width: 50px;
				height: 50px;
				animation: spin 1s linear infinite;
				margin: 0 auto 16px;
			}

			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.loading-text {
				color: #64748b;
				font-size: 15px;
			}

			.history-section {
				margin-top: 40px;
				padding-top: 40px;
				border-top: 2px solid #e2e8f0;
			}

			.history-section h3 {
				color: #1e293b;
				margin-bottom: 16px;
			}

			.history-item {
				background: #f8fafc;
				padding: 16px;
				margin: 12px 0;
				border-radius: 8px;
				cursor: pointer;
				transition: all 0.3s;
				border: 2px solid transparent;
			}

			.history-item:hover {
				background: #f1f5f9;
				border-color: #667eea;
				transform: translateX(4px);
			}

			.history-query {
				font-weight: 600;
				color: #334155;
				margin-bottom: 6px;
			}

			.history-meta {
				font-size: 13px;
				color: #64748b;
				display: flex;
				gap: 16px;
				flex-wrap: wrap;
			}

			.empty-state {
				text-align: center;
				padding: 60px 20px;
				color: #94a3b8;
			}

			.empty-state-icon {
				font-size: 48px;
				margin-bottom: 16px;
				opacity: 0.5;
			}

			@media (max-width: 768px) {
				.container {
					border-radius: 0;
				}

				.header {
					padding: 20px;
				}

				.header h1 {
					font-size: 24px;
				}

				.content {
					padding: 20px;
				}

				.button-group {
					flex-direction: column;
				}

				button {
					width: 100%;
					justify-content: center;
				}

				.stats {
					flex-direction: column;
				}

				.table-wrapper {
					border-radius: 0;
					margin-left: -20px;
					margin-right: -20px;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>
					<span>üîç</span>
					NL2SQL Dashboard
				</h1>
				<p>Ask questions about your database in plain English</p>

				<div class="stats">
					<div class="stat-item">
						üìä Cache
						<strong id="cacheSize">0</strong>
					</div>
					<div class="stat-item">
						üìú History
						<strong id="historyCount">0</strong>
					</div>
					<div class="stat-item">
						‚ö° TTL
						<strong id="cacheTTL">-</strong>s
					</div>
				</div>
			</div>

			<div class="content">
				<div class="query-section">
					<textarea
						id="query"
						placeholder="Ask anything about your database...

Examples:
  ‚Ä¢ Show me the top 10 orders with highest price
  ‚Ä¢ Count total customers
  ‚Ä¢ Find all pending orders
  ‚Ä¢ Show orders from last month"
					></textarea>

					<div class="button-group">
						<button class="btn-primary" onclick="runQuery()" id="runBtn">üöÄ Run Query</button>
						<button class="btn-secondary" onclick="loadHistory()">üìú Show History</button>
						<button class="btn-secondary" onclick="loadCacheStats()">üìä Cache Stats</button>
						<button class="btn-danger" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
					</div>
				</div>

				<div id="result"></div>

				<div class="history-section" id="historySection" style="display: none">
					<h3>Recent Queries</h3>
					<div id="historyList"></div>
				</div>
			</div>
		</div>

		<script>
			let isLoading = false

			window.addEventListener('DOMContentLoaded', () => {
				loadCacheStats()
			})

			async function runQuery() {
				const query = document.getElementById('query').value.trim()
				if (!query) {
					alert('‚ö†Ô∏è Please enter a query')
					return
				}

				if (isLoading) return
				isLoading = true

				const resultDiv = document.getElementById('result')
				const runBtn = document.getElementById('runBtn')

				runBtn.disabled = true
				resultDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Processing your query...</p>
                </div>
            `

				const startTime = Date.now()

				try {
					const response = await fetch('http://localhost:3004/api/query', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ query }),
					})

					const data = await response.json()
					const clientTime = Date.now() - startTime
					console.log(data)
					if (data.success) {
						const rows = data.data.result && data.data.result.rows ? Object.keys(data.data.result.rows[0]) : []
						const columns =
							data.data.result && data.data.result.rows && data.data.result.rows.length ? Object.keys(data.data.result.rows[0]) : []
						resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <span class="alert-icon">‚úÖ</span>
                            <div class="alert-content">
                                <strong>Query executed successfully</strong>
                                ${data.cached ? '<span class="cache-badge">‚ö° CACHED</span>' : ''}
                                <small>Execution time: ${data.cached ? data.cacheAge + 's (from cache)' : clientTime + 'ms'}</small>
                            </div>
                        </div>
                        
                        <h3>Generated SQL:</h3>
                        <div class="sql-block"><code>${escapeHtml(data.sql)}</code></div>
                        
                        <div class="results-header">
                            <h3>Query Results</h3>
                            <span class="row-count">${data.rowCount} rows</span>
                        </div>
                        ${
							data.rowCount === 0
								? '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No results found</p></div>'
								: createTable(rows, columns)
						}
                    `

						loadCacheStats()
					} else {
						resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <span class="alert-icon">‚ùå</span>
                            <div class="alert-content">
                                <strong>Query failed</strong>
                                <small>${data.error}</small>
                                ${data.suggestion ? `<small><strong>Suggestion:</strong> ${data.suggestion}</small>` : ''}
                            </div>
                        </div>
                        ${
							data.generatedSQL
								? `<h3>Generated SQL:</h3><div class="sql-block"><code>${escapeHtml(data.generatedSQL)}</code></div>`
								: ''
						}
                    `
					}
				} catch (error) {
					resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <span class="alert-icon">‚ùå</span>
                        <div class="alert-content">
                            <strong>Network error</strong>
                            <small>${error.message}</small>
                        </div>
                    </div>
                `
				} finally {
					isLoading = false
					runBtn.disabled = false
				}
			}

			async function loadHistory() {
				const historySection = document.getElementById('historySection')
				const historyList = document.getElementById('historyList')

				historyList.innerHTML = '<div class="loading"><div class="spinner"></div></div>'
				historySection.style.display = 'block'

				try {
					const response = await fetch('http://localhost:3004/api/history?limit=20')
					const data = await response.json()

					if (data.success && data.history.length > 0) {
						historyList.innerHTML = data.history
							.map(
								(item) => `
                        <div class="history-item" onclick="document.getElementById('query').value = \`${escapeHtml(item.query).replace(
							/`/g,
							'\\`'
						)}\`; window.scrollTo({top: 0, behavior: 'smooth'});">
                            <div class="history-query">${escapeHtml(item.query)}</div>
                            <div class="history-meta">
                                <span>üïê ${new Date(item.timestamp).toLocaleString()}</span>
                                <span>üìä ${item.rowCount} rows</span>
                                <span>‚ö° ${item.executionTime}ms</span>
                            </div>
                        </div>
                    `
							)
							.join('')
					} else {
						historyList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No query history yet</p></div>'
					}
				} catch (error) {
					historyList.innerHTML = `
                    <div class="alert alert-error">
                        <span class="alert-icon">‚ùå</span>
                        <div class="alert-content">
                            <strong>Failed to load history</strong>
                            <small>${error.message}</small>
                        </div>
                    </div>
                `
				}
			}

			async function loadCacheStats() {
				try {
					const response = await fetch('http://localhost:3004/api/cache/stats')
					const data = await response.json()

					if (data.success) {
						document.getElementById('cacheSize').textContent = data.cacheSize
						document.getElementById('cacheTTL').textContent = data.ttl
					}
				} catch (error) {
					console.error('Failed to load cache stats:', error)
				}

				try {
					const response = await fetch('http://localhost:3004/api/history?limit=1')
					const data = await response.json()
					if (data.success) {
						document.getElementById('historyCount').textContent = data.total
					}
				} catch (error) {
					console.error('Failed to load history count:', error)
				}
			}

			async function clearCache() {
				if (!confirm('Are you sure you want to clear the cache?')) return

				try {
					const response = await fetch('http://localhost:3004/api/cache', {
						method: 'DELETE',
					})
					const data = await response.json()

					if (data.success) {
						alert('‚úÖ Cache cleared successfully!')
						loadCacheStats()
					}
				} catch (error) {
					alert('‚ùå Failed to clear cache: ' + error.message)
				}
			}

			function createTable(rows, columns) {
				console.log(rows)
				console.log(columns)
				if (rows.length === 0) return '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No results found</p></div>'

				let html = '<div class="table-wrapper"><table><thead><tr>'

				columns.forEach((col) => {
					html += `<th>${escapeHtml(col)}</th>`
				})
				html += '</tr></thead><tbody>'

				rows.slice(0, 100).forEach((row) => {
					html += '<tr>'
					columns.forEach((col) => {
						let value = row[col]

						if (value === null || value === undefined) {
							html += '<td><span class="null-value">NULL</span></td>'
						} else {
							if (typeof value === 'object') {
								value = JSON.stringify(value)
							}

							const strValue = String(value)
							const displayValue = strValue.length > 50 ? strValue.substring(0, 50) + '...' : strValue

							if (strValue.length > 50) {
								html += `<td class="truncated" data-full="${escapeHtml(strValue)}" title="Click to see full value">${escapeHtml(
									displayValue
								)}</td>`
							} else {
								html += `<td>${escapeHtml(displayValue)}</td>`
							}
						}
					})
					html += '</tr>'
				})

				if (rows.length > 100) {
					html += `<tr><td colspan="${columns.length}" style="text-align:center; padding: 20px; color: #64748b; font-style: italic;">
                    ... and ${rows.length - 100} more rows (showing first 100)
                </td></tr>`
				}

				html += '</tbody></table></div>'
				return html
			}

			function escapeHtml(text) {
				const div = document.createElement('div')
				div.textContent = text
				return div.innerHTML
			}

			document.getElementById('query').addEventListener('keydown', function (e) {
				if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
					e.preventDefault()
					runQuery()
				}
			})
		</script>
	</body>
</html>
